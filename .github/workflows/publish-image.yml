name: ğŸš€ Publish Docker Image

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: Choose a version to publish
        required: true


jobs:
  publish_doc:
    name: ğŸ³ Docker
    runs-on: ubuntu-latest
    steps:
      - name: âœ”ï¸ Get version from release
        if: ${{ github.event_name == 'release'}}
        run: |
          TAG=${{ github.event.release.tag_name }}
          echo "VERSION=${TAG##v}" >> $GITHUB_ENV
          echo $VERSION
      - name: âœ”ï¸ Get version from manual launch
        if: ${{ github.event_name == 'workflow_dispatch'}}
        run: |
          TAG=${{ github.event.inputs.version }}
          echo "VERSION=${TAG##v}" >> $GITHUB_ENV
          echo $VERSION

      - name: ğŸ“¤ Checkout ${{ github.repository }}
        uses: actions/checkout@v4
        with:
          ref: v${{ env.VERSION }}

      # Login against a Docker
      - name: ğŸ” Log into DockerHub registry
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.OPT_DOCKERHUB_LOGIN }}
          password: ${{ secrets.OPT_DOCKERHUB_PASSWORD }}

      - name: ğŸ³ Build Docker image
        run: docker build -t optnc/airflow-extended-image:${{ env.VERSION }} -t optnc/airflow-extended-image:latest .

      - name: ğŸš€ Push Docker image to DockerHub Registry
        run: docker push --all-tags optnc/airflow-extended-image

      - name: ğŸ³ Add Docker Hub Description
        uses: peter-evans/dockerhub-description@v4
        with:
          username: ${{ secrets.OPT_DOCKERHUB_LOGIN }}
          password: ${{ secrets.OPT_DOCKERHUB_PASSWORD }}
          repository: optnc/airflow-extended-image
          readme-filepath: ./DOCKERHUB.md